{% extends 'base.html' %}
{% load static %}

{% block title %}Submit Purchase Offer for {{ property.title }}{% endblock %}

{% block content %}
<div class="offer-form-container">
    <div class="spo-header-row">
        <a href="{% url 'properties:property_details' property_id=property.id %}" class="back-button">&larr;</a>
        <h1 class="form-title">Submit Purchase Offer</h1>
    </div>

    <div class="property-summary">
        <div class="spo-property-info-box">
            <div class="spo-property-image">
                {% if property.images.first %}
                    <img src="{{ property.images.first.image.url }}" alt="{{ property.title }}">
                {% else %}
                    <img src="{% static '../../media/properties/images/placeholder.png' %}" alt="No image available">
                {% endif %}
            </div>
            <div class="spo-property-details">
                <h2>{{ property.title }}</h2>
                <p class="spo-property-address">{{ property.street_address }}</p>
                <p class="spo-property-price">Listed Price: {{ property.get_formatted_price }} kr.</p>
            </div>
        </div>
    </div>

    <div class="offer-form">
        <h2>Your Offer Details</h2>
        
        <form method="post" action="{% url 'offers:submit_purchase_offer' property_id=property.id %}" class="offer-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="offer_price">Offer Amount (ISK)</label>
                <input type="number" id="offer_price" name="offer_price" required min="1" 
                       placeholder="Enter your offer amount in ISK">
            </div>
            
            <div class="form-group">
                <label for="expiration_date">Offer Valid Until</label>
                <input type="date" id="expiration_date" name="expiration_date" required>
                <small class="date-hint">Your offer will remain valid until this date</small>
            </div>
            
            <div class="form-group terms-group">
                <input type="checkbox" id="terms_agreement" name="terms_agreement" required>
                <label for="terms_agreement">I agree that this offer is binding and I am prepared to proceed with the purchase if accepted</label>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'properties:property_details' property_id=property.id %}" class="cancel-button">Cancel</a>
                <button type="submit" class="submit-button">Submit Offer</button>
            </div>
        </form>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modal-title">Offer Submission</h2>
            <p id="modal-message"></p>
            <div class="modal-actions">
                <a href="#" id="modal-ok-button" class="modal-button">OK</a>
            </div>
        </div>
    </div>
</div>

{#<style>#}
{#    /* General Styles */#}
{#    .offer-form-container {#}
{#        max-width: 800px;#}
{#        margin: 0 auto;#}
{#        padding: 20px;#}
{#    }#}
{#    #}
{#    .header-row {#}
{#        display: flex;#}
{#        align-items: center;#}
{#        margin-bottom: 20px;#}
{#    }#}
{#    #}
{#    .back-button {#}
{#        font-size: 24px;#}
{#        text-decoration: none;#}
{#        margin-right: 15px;#}
{#        color: #333;#}
{#    }#}
{#    #}
{#    .form-title {#}
{#        margin: 0;#}
{#    }#}
{#    #}
{#    /* Property Summary */#}
{#    .property-summary {#}
{#        margin-bottom: 30px;#}
{#    }#}
{#    #}
{#    .property-info-box {#}
{#        display: flex;#}
{#        background-color: #f9f9f9;#}
{#        border-radius: 8px;#}
{#        overflow: hidden;#}
{#        box-shadow: 0 2px 10px rgba(0,0,0,0.1);#}
{#    }#}
{#    #}
{#    .property-image {#}
{#        width: 200px;#}
{#        height: 150px;#}
{#        overflow: hidden;#}
{#    }#}
{#    #}
{#    .property-image img {#}
{#        width: 100%;#}
{#        height: 100%;#}
{#        object-fit: cover;#}
{#    }#}
{#    #}
{#    .property-details {#}
{#        flex: 1;#}
{#        padding: 15px;#}
{#    }#}
{#    #}
{#    .property-details h2 {#}
{#        margin-top: 0;#}
{#        margin-bottom: 10px;#}
{#        font-size: 1.3rem;#}
{#    }#}
{#    #}
{#    .property-address {#}
{#        color: #666;#}
{#        margin-bottom: 10px;#}
{#    }#}
{#    #}
{#    .property-price {#}
{#        font-weight: bold;#}
{#        color: #2a6496;#}
{#    }#}
{#    #}
{#    /* Offer Form */#}
{#    .offer-form {#}
{#        background-color: #fff;#}
{#        padding: 25px;#}
{#        border-radius: 8px;#}
{#        box-shadow: 0 2px 10px rgba(0,0,0,0.1);#}
{#    }#}
{#    #}
{#    .offer-form h2 {#}
{#        margin-top: 0;#}
{#        margin-bottom: 20px;#}
{#        color: #333;#}
{#    }#}
{#    #}
{#    .form-group {#}
{#        margin-bottom: 20px;#}
{#    }#}
{#    #}
{#    .form-group label {#}
{#        display: block;#}
{#        margin-bottom: 8px;#}
{#        font-weight: bold;#}
{#        color: #333;#}
{#    }#}
{#    #}
{#    .form-group input[type="number"],#}
{#    .form-group input[type="date"] {#}
{#        width: 100%;#}
{#        padding: 10px;#}
{#        border: 1px solid #ddd;#}
{#        border-radius: 4px;#}
{#        font-size: 16px;#}
{#    }#}
{#    #}
{#    .date-hint {#}
{#        display: block;#}
{#        margin-top: 5px;#}
{#        color: #666;#}
{#        font-size: 0.9rem;#}
{#    }#}
{#    #}
{#    .terms-group {#}
{#        display: flex;#}
{#        align-items: flex-start;#}
{#    }#}
{#    #}
{#    .terms-group input {#}
{#        margin-top: 5px;#}
{#        margin-right: 10px;#}
{#    }#}
{#    #}
{#    .form-actions {#}
{#        display: flex;#}
{#        gap: 15px;#}
{#    }#}
{#    #}
{#    .submit-button {#}
{#        flex: 1;#}
{#        padding: 12px;#}
{#        background-color: #4CAF50;#}
{#        color: white;#}
{#        border: none;#}
{#        border-radius: 4px;#}
{#        font-size: 16px;#}
{#        font-weight: bold;#}
{#        cursor: pointer;#}
{#        transition: background-color 0.3s;#}
{#    }#}
{#    #}
{#    .submit-button:hover {#}
{#        background-color: #45a049;#}
{#    }#}
{#    #}
{#    .cancel-button {#}
{#        flex: 1;#}
{#        padding: 12px;#}
{#        background-color: #f5f5f5;#}
{#        color: #333;#}
{#        border: 1px solid #ddd;#}
{#        border-radius: 4px;#}
{#        font-size: 16px;#}
{#        font-weight: bold;#}
{#        text-align: center;#}
{#        text-decoration: none;#}
{#        cursor: pointer;#}
{#        transition: background-color 0.3s;#}
{#    }#}
{#    #}
{#    .cancel-button:hover {#}
{#        background-color: #e5e5e5;#}
{#    }#}
{#    #}
{#    /* Modal Styles */#}
{#    .modal {#}
{#        display: none;#}
{#        position: fixed;#}
{#        z-index: 1000;#}
{#        left: 0;#}
{#        top: 0;#}
{#        width: 100%;#}
{#        height: 100%;#}
{#        background-color: rgba(0,0,0,0.5);#}
{#    }#}
{#    #}
{#    .modal-content {#}
{#        position: relative;#}
{#        background-color: #fff;#}
{#        margin: 15% auto;#}
{#        padding: 25px;#}
{#        width: 80%;#}
{#        max-width: 500px;#}
{#        border-radius: 8px;#}
{#        box-shadow: 0 4px 20px rgba(0,0,0,0.2);#}
{#    }#}
{#    #}
{#    .close-button {#}
{#        position: absolute;#}
{#        top: 10px;#}
{#        right: 15px;#}
{#        font-size: 24px;#}
{#        color: #aaa;#}
{#        cursor: pointer;#}
{#    }#}
{#    #}
{#    .close-button:hover {#}
{#        color: #333;#}
{#    }#}
{#    #}
{#    #modal-title {#}
{#        margin-top: 0;#}
{#        color: #333;#}
{#    }#}
{#    #}
{#    .modal-actions {#}
{#        margin-top: 20px;#}
{#        text-align: right;#}
{#    }#}
{#    #}
{#    .modal-button {#}
{#        display: inline-block;#}
{#        padding: 10px 20px;#}
{#        background-color: #4CAF50;#}
{#        color: white;#}
{#        border-radius: 4px;#}
{#        text-decoration: none;#}
{#        font-weight: bold;#}
{#    }#}
{#    #}
{#    .modal-button:hover {#}
{#        background-color: #45a049;#}
{#    }#}
{#</style>#}
{##}
{#<script>#}
{#    // Set minimum date to today for the expiration date input#}
{#    document.addEventListener('DOMContentLoaded', function() {#}
{#        const today = new Date();#}
{#        const dd = String(today.getDate()).padStart(2, '0');#}
{#        const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!#}
{#        const yyyy = today.getFullYear();#}
{#        #}
{#        const minDate = yyyy + '-' + mm + '-' + dd;#}
{#        document.getElementById('expiration_date').min = minDate;#}
{#        #}
{#        // Set default date to 7 days from now#}
{#        const nextWeek = new Date(today);#}
{#        nextWeek.setDate(today.getDate() + 7);#}
{#        const nextWeekDD = String(nextWeek.getDate()).padStart(2, '0');#}
{#        const nextWeekMM = String(nextWeek.getMonth() + 1).padStart(2, '0');#}
{#        const nextWeekYYYY = nextWeek.getFullYear();#}
{#        #}
{#        const defaultDate = nextWeekYYYY + '-' + nextWeekMM + '-' + nextWeekDD;#}
{#        document.getElementById('expiration_date').value = defaultDate;#}
{#        #}
{#        // Form submission handling#}
{#        const form = document.getElementById('purchase-offer-form');#}
{#        const modal = document.getElementById('confirmation-modal');#}
{#        const closeButton = document.querySelector('.close-button');#}
{#        const modalOkButton = document.getElementById('modal-ok-button');#}
{#        #}
{#        form.addEventListener('submit', function(e) {#}
{#            e.preventDefault();#}
{#            #}
{#            const formData = new FormData(form);#}
{#            #}
{#            // Check terms agreement#}
{#            if (!formData.get('terms_agreement')) {#}
{#                showModal('Error', 'You must agree to the terms to proceed.', false);#}
{#                return;#}
{#            }#}
{#            #}
{#            // Validate offer price#}
{#            const offerPrice = formData.get('offer_price');#}
{#            if (!offerPrice || offerPrice <= 0) {#}
{#                showModal('Error', 'Please enter a valid offer amount.', false);#}
{#                return;#}
{#            }#}
{#            #}
{#            // Send AJAX request#}
{#            fetch("{% url 'offers:submit_purchase_offer' property_id=property.id %}", {#}
{#                method: 'POST',#}
{#                body: formData,#}
{#                headers: {#}
{#                    'X-Requested-With': 'XMLHttpRequest'#}
{#                }#}
{#            })#}
{#            .then(response => response.json())#}
{#            .then(data => {#}
{#                if (data.success) {#}
{#                    showModal('Success', data.message, true);#}
{#                } else {#}
{#                    showModal('Error', data.message, false);#}
{#                }#}
{#            })#}
{#            .catch(error => {#}
{#                console.error('Error:', error);#}
{#                showModal('Error', 'An unexpected error occurred. Please try again.', false);#}
{#            });#}
{#        });#}
{#        #}
{#        function showModal(title, message, isSuccess) {#}
{#            document.getElementById('modal-title').textContent = title;#}
{#            document.getElementById('modal-message').textContent = message;#}
{#            #}
{#            if (isSuccess) {#}
{#                modalOkButton.href = "{% url 'properties:property_details' property_id=property.id %}";#}
{#            } else {#}
{#                modalOkButton.href = "#";#}
{#                modalOkButton.onclick = function() {#}
{#                    modal.style.display = "none";#}
{#                    return false;#}
{#                };#}
{#            }#}
{#            #}
{#            modal.style.display = "block";#}
{#        }#}
{#        #}
{#        // Close modal when clicking the × button#}
{#        closeButton.onclick = function() {#}
{#            modal.style.display = "none";#}
{#        }#}
{#        #}
{#        // Close modal when clicking outside of it#}
{#        window.onclick = function(event) {#}
{#            if (event.target == modal) {#}
{#                modal.style.display = "none";#}
{#            }#}
{#        }#}
{#    });#}
{#</script>#}
{% endblock %}